#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from enum import Enum
from os import urandom
from pwn import *

import Crypto.Cipher.AES as AES
from Crypto.Random import get_random_bytes
import numpy as np
import math

A = b'a'
key = b'\x00' * 16
HASH = b'#'

LOCALHOST = 'localhost'
HOST = 'h4x.0x04.net'
PORT = 13370
BLOCK_SIZE = AES.block_size
ENTER = b'Enter encrypted command.\n'

class Remote(pwnlib.tubes.remote.remote):
    def __init__(self, host, port):
        super().__init__(host, port)

    def sendx(self, msg):
        return super().sendline(msg.hex())

    def recvx(self, n):
        return super().recv(n)


class AESCipher:
    def __init__(self, remote):
        #self.key = md5(key.encode('utf8')).digest()
        self.r = remote

    def pad(self, data):
        l = len(data)
        n = math.ceil(l / AES.block_size) if l > 0 else 1
        return data.ljust(n * AES.block_size, b'#')

    def encrypt(self, msg):
        self.r.recvuntil(ENTER)

        iv = bytearray(b'\x00' * AES.block_size)
        data = b'#' * AES.block_size

        for i in range(AES.block_size):
            for j in range(256):
                iv[i] = j
                self.r.sendx(self.pad(bytes(iv) + data))

            e = self.r.recvuntil(ENTER * 2).split(b'\n')
            x = list(filter(lambda y: y == ENTER[:-1], e))
            self.r.clean()
            iv[i] = len(x) - 1
            iv[i] ^= ord(b'#') ^ ord(b' ')

        for i in range(len(msg)):
            iv[i] ^= ord(b' ') ^ msg[i]

        return self.pad(iv + data)

    def decrypt(self, data):
        raw = b64decode(data)
        self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size])
        return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size)


class Exploit:
    def __init__(self, host, port):
        self.r = Remote(host, port)
        self.aes = AESCipher(self.r)

    def run(self):
        #iv = get_random_bytes(BLOCK_SIZE)

        self.r.sendx(self.aes.encrypt(b'cat flag.txt'))
        flag = bytes.fromhex(self.r.recvline().decode())
        info(f'encrypted flag: {flag}')

        #cipher = AES.new(mode=AES.MODE_CBC, key=key, iv=iv)
        #msg = iv + cipher.encrypt(b'\x01' * 15 + b'\x01')
        #msg += b'cat    flag.txt flag.txt flag.txt flag.txt'
        #msg = b'dupa'

        #self.r.send(msg.hex())
        #self.r.close()

        self.r.interactive()


def main():
    Exploit(LOCALHOST, PORT).run()


if __name__ == '__main__':
    main()
